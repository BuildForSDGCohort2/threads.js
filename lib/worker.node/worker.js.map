{"version":3,"sources":["worker.node/worker.js"],"names":[],"mappings":"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","file":"worker.node/worker.js","sourcesContent":["import child        from 'child_process';\nimport path         from 'path';\nimport EventEmitter from 'eventemitter3';\n\nimport { getConfig } from '../config';\n\n\nexport default class Worker extends EventEmitter {\n  constructor(initialRunnable, options = {}) {\n    super();\n\n    this.slave = child.fork(path.join(__dirname, 'slave.js'), [], options);\n    this.slave.on('message', this.handleMessage.bind(this));\n    this.slave.on('error', this.handleError.bind(this));\n    this.slave.on('exit', this.emit.bind(this, 'exit'));\n\n    if (initialRunnable) {\n      this.run(initialRunnable);\n    }\n  }\n\n  run(toRun) {\n    if (typeof toRun === 'function') {\n      this.runMethod(toRun);\n    } else {\n      this.runScript(toRun);\n    }\n    return this;\n  }\n\n  runMethod(method) {\n    this.slave.send({\n      initByMethod : true,\n      method       : method.toString()\n    });\n  }\n\n  runScript(script) {\n    if (!script) { throw new Error('Must pass a function or a script path to run().'); }\n\n    const prefixedScriptPath = path.join(getConfig().basepath.node, script);\n\n    // attention: single script for node, array for browser\n    this.slave.send({\n      initByScript : true,\n      script       : path.resolve(prefixedScriptPath)\n    });\n  }\n\n  send(param) {\n    this.slave.send({\n      doRun : true,\n      param\n    });\n    return this;\n  }\n\n  kill() {\n    this.slave.kill();\n    return this;\n  }\n\n  handleMessage(message) {\n    if (message.error) {\n      const error = new Error(message.error.message);\n      error.stack = message.error.stack;\n\n      this.handleError(error);\n    } else {\n      this.emit('message', ...message.response);\n    }\n  }\n\n  handleError(error) {\n    if (!this.listeners('error', true)) {\n      console.error(error.stack || error);       // eslint-disable-line no-console\n    }\n    this.emit('error', error);\n  }\n}\n"],"sourceRoot":"/source/"}